#!/bin/sh
cfgid="pulpmonad"
output="$1"
cache="$( dirname "$1" )"
src="./app"

lastModified () {
    if [ -e "$1" ]; then stat -c '%Y' "$1"; else echo "0"; fi
}

lastModifiedIn () {
    find "$1" -type f -exec stat -c '%Y' "{}" \; | sort -n | tail -1
}

max_number() {
    printf "%s\n" "$@" | sort -r | head -n1
}

install_app () {
    if [ "$( lastModifiedIn "$2" )" -gt "$( lastModified "$3/$1" )" ] ; then
        echo "Updated, installing at $3..."
        cabal install "$1" \
            --installdir="$3" --install-method=copy \
            --overwrite-policy=always
    fi
}

echo "Build script running."
install_app "$cfgid" "$src" "$cache"
ln -sf "$cache/$cfgid" "$output"
